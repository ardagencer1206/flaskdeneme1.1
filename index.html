<!doctype html>
<html lang="tr" data-bs-theme="light">
<head>
  <meta charset="utf-8" />
  <title>Heterojen Filolu √áok Duru≈ülu Lojistik Optimizasyonu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root{ --glass-bg: color-mix(in oklab, var(--bs-body-bg) 70%, transparent); --glass-bd: color-mix(in oklab, var(--bs-body-color) 15%, transparent); }
    body{
      background: radial-gradient(1200px 800px at 10% -10%, rgba(13,110,253,.08), transparent 40%),
                  radial-gradient(800px 800px at 120% 20%, rgba(111,66,193,.10), transparent 35%),
                  var(--bs-body-bg); min-height: 100dvh;
    }
    .glass{ background: var(--glass-bg); backdrop-filter: saturate(1.2) blur(6px); -webkit-backdrop-filter: saturate(1.2) blur(6px); border: 1px solid var(--glass-bd); }
    .shadow-soft{ box-shadow: 0 10px 30px rgba(0,0,0,.06); }
    pre.code{ white-space: pre-wrap; font-family: ui-monospace,Menlo,Consolas,monospace }
    .hero{ background: linear-gradient(135deg, rgba(13,110,253,.12), rgba(111,66,193,.10)); border-bottom: 1px solid var(--bs-border-color); }
    .btn-ghost{ background: transparent; border: 1px solid var(--bs-border-color); }
    .btn-ghost:hover{ background: color-mix(in oklab, var(--bs-primary) 10%, transparent); }
    .footnote{ font-size:.875rem; color: var(--bs-secondary-color); }
    .bubble { white-space: pre-wrap; }
    .bubble.user{ background:#0d6efd;color:#fff;border-radius:1rem;padding:.5rem .75rem;margin:.25rem 0;align-self:flex-end;max-width:90% }
    .bubble.assistant{ background:var(--bs-secondary-bg);color:var(--bs-body-color);border-radius:1rem;padding:.5rem .75rem;margin:.25rem 0;max-width:90% }
    #chatBox{ display:flex;flex-direction:column;gap:.25rem }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-md sticky-top glass shadow-soft">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center gap-2" href="#">
        <span class="badge rounded-pill text-bg-primary">Pyomo</span>
        <span class="fw-semibold">Lojistik Optimizasyonu</span>
      </a>
      <div class="d-flex align-items-center gap-2">
        <button class="btn btn-sm btn-ghost" id="themeToggle" type="button" aria-label="Tema deƒüi≈ütir">
          <i class="bi bi-sun-fill d-none" id="iconSun"></i>
          <i class="bi bi-moon-stars-fill" id="iconMoon"></i>
        </button>
        <a class="btn btn-sm btn-primary" href="#main">Ba≈üla</a>
      </div>
    </div>
  </nav>

  <header class="hero">
    <div class="container py-5">
      <div class="row align-items-center g-4">
        <div class="col-12 col-lg-7">
          <h1 class="display-6 mb-2">Bitirmede Saplama Heterojen Filolu √áok Duru≈ülu Lojistik Optimizasyonu</h1>
          <p class="lead mb-0 text-secondary">
            Bu sayfa <b>dataset.json</b>‚Äôu <u>read-only</u> g√∂sterir. √á√∂z√ºm, sunucudaki dataset ile yapƒ±lƒ±r.
          </p>
        </div>
        <div class="col-12 col-lg-5">
          <div class="glass rounded-4 p-3 shadow-soft">
            <div class="d-flex align-items-center gap-3">
              <i class="bi bi-graph-up-arrow fs-1 text-primary"></i>
              <div>
                <div class="fw-semibold">ƒ∞pucu</div>
                <div class="text-secondary small">Dataset‚Äôi deƒüi≈ütirmek i√ßin saƒü √ºstteki <b>Dataset‚Äôi G√ºncelle</b> butonunu kullan.</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main id="main" class="container my-5">
    <div class="row g-4">
      <div class="col-12 col-lg-6">
        <div class="card glass shadow-soft border-0 rounded-4">
          <div class="card-body p-4">
            <div class="d-flex align-items-center justify-content-between mb-3">
              <h3 class="h5 mb-0">üîß Model Girdileri (Read-only)</h3>
              <div class="d-flex gap-2">
                <a class="btn btn-sm btn-outline-primary" id="downloadBtn">JSON‚Äôu indir</a>
                <a class="btn btn-sm btn-dark" href="/edit.html">Dataset‚Äôi G√ºncelle</a>
              </div>
            </div>

            <div class="mb-3">
              <label for="cities" class="form-label">≈ûehirler (JSON dizi)</label>
              <input id="cities" class="form-control" disabled />
            </div>

            <div class="row g-3 mb-3">
              <div class="col-12 col-md-6">
                <label for="main_depot" class="form-label">Ana Depo</label>
                <input id="main_depot" class="form-control" disabled />
              </div>
              <div class="col-12 col-md-6">
                <label for="periods" class="form-label">D√∂nem Sayƒ±sƒ±</label>
                <input id="periods" type="number" class="form-control" disabled />
              </div>
            </div>

            <div class="mb-3">
              <label for="vehicle_types" class="form-label">Ara√ß Tipleri (JSON)</label>
              <textarea id="vehicle_types" class="form-control" rows="6" disabled></textarea>
            </div>

            <div class="mb-3">
              <label for="vehicle_count" class="form-label">Ara√ß Sayƒ±larƒ± (JSON)</label>
              <textarea id="vehicle_count" class="form-control" rows="4" disabled></textarea>
            </div>

            <div class="mb-3">
              <label for="distances" class="form-label">Mesafeler (liste; [i, j, km])</label>
              <textarea id="distances" class="form-control" rows="5" disabled></textarea>
            </div>

            <div class="mb-3">
              <label for="packages" class="form-label">Paketler (liste)</label>
              <textarea id="packages" class="form-control" rows="7" disabled></textarea>
            </div>

            <div class="row g-3">
              <div class="col-12 col-md-6">
                <label for="minutil_penalty" class="form-label">Min. Doluluk Ceza (TL/kg)</label>
                <input id="minutil_penalty" class="form-control" type="number" disabled />
              </div>
              <div class="col-12 col-md-6 d-flex align-items-end">
                <button id="solveBtn" class="btn btn-primary w-100">√á√∂z (Sunucu dataset‚Äôi ile)</button>
              </div>
            </div>

            <div id="status" class="text-secondary small mt-3"></div>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-6">
        <div class="card glass shadow-soft border-0 rounded-4">
          <div class="card-body p-4">
            <div class="d-flex align-items-center justify-content-between mb-3">
              <h3 class="h5 mb-0">üìà Sonu√ßlar</h3>
              <span class="badge rounded-pill text-bg-info-subtle text-info-emphasis">Canlƒ±</span>
            </div>
            <div id="results" class="text-secondary">Hen√ºz √ß√∂z√ºm yok. <b>√á√∂z</b>‚Äôe basƒ±n.</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card glass shadow-soft border-0 rounded-4 mt-4">
      <div class="card-body p-4">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
          <h3 class="h6 mb-0">‚ÑπÔ∏è Not</h3>
          <span class="badge text-bg-light">Bu sayfa read-only‚Äôdir</span>
        </div>
        <ul class="text-secondary mb-0">
          <li>Dataset‚Äôi deƒüi≈ütirmek i√ßin <b>Dataset‚Äôi G√ºncelle</b> butonuna tƒ±klayƒ±n.</li>
          <li>Kaydedilen deƒüi≈üiklikler hemen √ß√∂z√ºme yansƒ±r.</li>
        </ul>
      </div>
    </div>

    <p class="mt-3 footnote"> TOBB ET√ú End√ºstri <code>/solve</code> Bitirme Team</p>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const $  = (id) => document.getElementById(id);

    function fmtTL(x){
      const v = Number.isFinite(x) ? x : 0;
      return (Math.round(v*100)/100).toLocaleString("tr-TR",{minimumFractionDigits:2,maximumFractionDigits:2}) + " TL";
    }

    function setStatus(msg, type="secondary"){
      const s = $("status"); if (!s) return;
      s.innerHTML = `<span class="text-${type}">${msg}</span>`;
    }

    async function loadDataset(){
      setStatus("Dataset y√ºkleniyor‚Ä¶");
      try{
        let res = await fetch("/dataset", { cache: "no-store" });
        let data;
        if(res.ok){
          const js = await res.json();
          if(js && js.ok && js.dataset) data = js.dataset;
        }
        if(!data){
          const res2 = await fetch(`/dataset.json?v=${Date.now()}`, { cache: "no-store" });
          if(!res2.ok) throw new Error("dataset.json okunamadƒ±");
          data = await res2.json();
        }
        $("cities").value = JSON.stringify(data.cities ?? [], null, 0);
        $("main_depot").value = data.main_depot ?? "";
        $("periods").value = data.periods ?? 1;
        $("vehicle_types").value = JSON.stringify(data.vehicle_types ?? {}, null, 2);
        $("vehicle_count").value = JSON.stringify(data.vehicle_count ?? {}, null, 2);
        $("distances").value = JSON.stringify(data.distances ?? [], null, 2);
        $("packages").value = JSON.stringify(data.packages ?? [], null, 2);
        $("minutil_penalty").value = (data.minutil_penalty ?? 10).toString();
        setStatus("Dataset y√ºklendi ‚úîÔ∏è","success");
      }catch(e){
        console.error(e);
        setStatus("Dataset y√ºklenemedi: "+e.message, "danger");
      }
    }

    function renderResults(resp){
      const el = $("results");
      if(!resp || resp.ok === false){
        const msg = (resp && resp.error) ? resp.error : "Bilinmeyen hata";
        el.innerHTML = `<div class="alert alert-warning mb-0">${msg}</div>`;
        return;
      }
      const r = resp.result || {};
      let html = "";
      html += `<div class="d-flex flex-wrap gap-2 align-items-center mb-3">
        <span class="badge rounded-pill text-bg-primary">√á√∂z√ºc√º: ${resp.solver}</span>
        <span class="badge rounded-pill text-bg-success">Ama√ß: ${fmtTL(r.objective)}</span>
      </div>`;
      const cb = r.cost_breakdown || {};
      html += `<h6 class="mt-2">Maliyet Daƒüƒ±lƒ±mƒ±</h6>
      <div class="table-responsive"><table class="table table-sm table-hover align-middle mb-3">
        <thead class="table-light"><tr><th>Kalem</th><th>Tutar</th></tr></thead>
        <tbody>
          <tr><td>Ta≈üƒ±ma</td><td>${fmtTL(cb.transport)}</td></tr>
          <tr><td>Sabit</td><td>${fmtTL(cb.fixed)}</td></tr>
          <tr><td>Gecikme</td><td>${fmtTL(cb.lateness)}</td></tr>
          <tr><td>Min. doluluk a√ßƒ±ƒüƒ±</td><td>${fmtTL(cb.min_util_gap)}</td></tr>
        </tbody></table></div>`;
      if ((r.vehicle_routes||[]).length){
        html += `<h6>Ara√ß Rotalarƒ±</h6>`;
        r.vehicle_routes.forEach(vr=>{
          html += `<div class="border rounded-3 p-2 mb-2">
            <div class="fw-semibold">${vr.vehicle} <span class="text-secondary fw-normal">(Kapasite: ${vr.capacity} kg)</span></div>
            <div class="table-responsive"><table class="table table-sm table-hover mb-0">
              <thead class="table-light"><tr><th>t</th><th>Rota</th><th>Mesafe</th><th>Y√ºk</th><th>Doluluk</th><th>Paketler</th></tr></thead><tbody>`;
          (vr.legs||[]).forEach(l=>{
            html += `<tr><td>${l.t}</td><td>${l.from} ‚Üí ${l.to}</td><td>${l.km} km</td><td>${Math.round(l.load_kg)} kg</td><td>${(l.utilization_pct||0).toFixed(1)}%</td><td>${(l.packages||[]).join(", ")||"‚Äî"}</td></tr>`;
          });
          html += `</tbody></table></div></div>`;
        });
      }
      if ((r.packages||[]).length){
        html += `<h6 class="mt-3">Paketler</h6>
        <div class="table-responsive"><table class="table table-sm table-hover align-middle">
          <thead class="table-light"><tr><th>ID</th><th>G√ºzerg√¢h</th><th>Hazƒ±r</th><th>Termin</th><th>Teslim</th><th>Durum</th><th>Ceza</th></tr></thead><tbody>`;
        r.packages.forEach(p=>{
          const delivered = (p.delivered_at!==null && p.delivered_at!==undefined);
          html += `<tr><td><b>${p.id}</b></td><td>${p.origin} ‚Üí ${p.dest}</td><td>${p.ready}</td><td>${p.deadline_by}</td><td>${delivered? p.delivered_at : "‚Äî"}</td><td>${delivered? (p.on_time? "‚úÖ Zamanƒ±nda":"‚ö†Ô∏è Gecikmeli"):"‚ùå Teslim yok"}</td><td>${fmtTL(p.lateness_penalty||0)}</td></tr>`;
        });
        html += `</tbody></table></div>`;
      }
      el.innerHTML = html;
    }

    async function runSolveUsingServerDataset() {
      const res  = await fetch("/solve?use_dataset=1", {
        method: "POST", headers: { "Content-Type": "application/json" }, body: "{}"
      });
      const raw   = await res.text();
      if(!(res.headers.get("content-type")||"").includes("application/json")) throw new Error("Sunucudan JSON yerine HTML/metin geldi: " + raw.slice(0,300));
      const data = JSON.parse(raw);
      if (!res.ok || data.ok === false) throw new Error(data.error || raw.slice(0,300) || ("HTTP " + res.status));
      return data;
    }

    $("solveBtn")?.addEventListener("click", async ()=>{
      $("solveBtn").disabled = true;
      setStatus("√á√∂z√ºl√ºyor‚Ä¶");
      try{
        const data = await runSolveUsingServerDataset();
        renderResults(data);
        setStatus("Tamamlandƒ± ‚úîÔ∏è","success");
      }catch(err){
        console.error(err);
        $("results").innerHTML = `<div class="alert alert-danger">Hata: ${err.message}</div>`;
        setStatus("Hata olu≈ütu","danger");
      }finally{
        $("solveBtn").disabled = false;
      }
    });

    $("downloadBtn")?.addEventListener("click", async ()=>{
      try{
        const res = await fetch("/dataset", { cache:"no-store" });
        let dataset;
        if(res.ok){ const js=await res.json(); dataset = js?.dataset; }
        if(!dataset){ const r2=await fetch(`/dataset.json?v=${Date.now()}`); dataset = await r2.json(); }
        const blob = new Blob([JSON.stringify(dataset,null,2)], {type:"application/json;charset=utf-8"});
        const url  = URL.createObjectURL(blob); const a=document.createElement("a");
        a.href=url; a.download="dataset.json"; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        setStatus("JSON indirildi.","success");
      }catch(e){ setStatus("ƒ∞ndirme hatasƒ±: "+e.message,"danger"); }
    });

    (function themeInit(){
      const html=document.documentElement, toggle=document.getElementById("themeToggle"), sun=$("iconSun"), moon=$("iconMoon");
      function apply(t){ html.setAttribute("data-bs-theme",t); const isL=t==="light"; sun?.classList.toggle("d-none",!isL); moon?.classList.toggle("d-none",isL); try{localStorage.setItem("ui-theme",t);}catch{} }
      const saved=(()=>{ try{return localStorage.getItem("ui-theme");}catch{return null} })(); apply(saved||"light");
      toggle?.addEventListener("click",()=>apply(html.getAttribute("data-bs-theme")==="light"?"dark":"light"));
    })();

    loadDataset();
  </script>
</body>
</html>
